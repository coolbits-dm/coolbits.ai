
STATUS: some fixes applied locally — created `app/lib/cost.ts`, `app/lib/rateLimit.ts`, `app/lib/idtoken.ts` and adjusted relative imports in server files. Build/deploy still pending (see next steps).

Observație: problema originală provenea din două cauze:

- deps: conflict vitest 2.x vs @vitest/coverage-v8 1.x → npm ci pica la rezolvare.

- importuri: aliasul @/... nu era configurat → Next nu găsea @/app/lib/cost, @/app/lib/rateLimit, @/lib/idtoken, @/app/components/StatusCard.

Plan recomandat (quick, safe, deterministic):

scriem fișierele lipsă (app/lib/cost.ts, app/lib/rateLimit.ts, app/lib/idtoken.ts),

schimbăm importurile pe relative (evităm aliasul),

rezolvăm deps prin npm install --legacy-peer-deps (regenerează lock fără să mai lovească în peer deps vechi),

build → deploy → smoke.

Trimite Asta lui @oCL (PATCH: fișiere + importuri, fără build)

creează fișierele și face replace la importuri. Se oprește. Nu rulează build/deploy.

Scrie fișiere + repară importuri (oprește-te după scriere; NO build/deploy).

# 1) app/lib/cost.ts
@'
export const PRICING = {
  "gpt-5": { in: 1.25, out: 10.0 },
  "gpt-5-mini": { in: 0.25, out: 2.0 },
  "gpt-4.1-mini": { in: 0.40, out: 1.60 },
} as const;

export type Usage = { prompt_tokens?: number; output_tokens?: number };

export function estimateUSD(model: string, usage: Usage = {}): number {
  const p: any = (PRICING as any)[model];
  if (!p) return 0;
  const pt = Number(usage.prompt_tokens || 0);
  const ot = Number(usage.output_tokens || 0);
  return ((pt * p.in) + (ot * p.out)) / 1_000_000;
}
'@ > app/lib/cost.ts

# 2) app/lib/rateLimit.ts
@'
type Bucket = { tokens: number; resetAt: number };
const BUCKET = new Map<string, Bucket>();

export function rateLimitHit(key: string, limit = 10, windowMs = 60_000) {
  const now = Date.now();
  let s = BUCKET.get(key) ?? { tokens: limit, resetAt: now + windowMs };
  if (now > s.resetAt) { s = { tokens: limit, resetAt: now + windowMs }; }
  if (s.tokens <= 0) { BUCKET.set(key, s); return { ok: false, remaining: 0, resetAt: s.resetAt }; }
  s.tokens -= 1; BUCKET.set(key, s);
  return { ok: true, remaining: s.tokens, resetAt: s.resetAt };
}
'@ > app/lib/rateLimit.ts

# 3) app/lib/idtoken.ts
@'
export async function fetchWithIdToken(url: string, audience: string, init: RequestInit = {}) {
  const r = await fetch(
    "http://metadata/computeMetadata/v1/instance/service-accounts/default/identity?audience=" + encodeURIComponent(audience),
    { headers: { "Metadata-Flavor": "Google" }, cache: "no-store" }
  );
  if (!r.ok) throw new Error(`idtoken metadata failed: ${r.status}`);
  const token = await r.text();
  const headers = new Headers(init.headers || {});
  headers.set("Authorization", `Bearer ${token}`);
  return fetch(url, { ...init, headers });
}
'@ > app/lib/idtoken.ts

# 4) Repară importurile la relative paths
#   a) app/api/complete/route.ts  "@/app/lib/cost"      -> "../../lib/cost"
#   b) app/api/costs/today/route.ts "@/app/lib/cost"    -> "../../../lib/cost"
#   c) app/api/estimate/route.ts "@/app/lib/rateLimit"  -> "../../lib/rateLimit"
#   d) app/api/info/route.ts "@/lib/idtoken"            -> "../../lib/idtoken"
#   e) app/page.tsx "@/app/components/StatusCard"       -> "./components/StatusCard"

(gwmi win32_process -Filter "name='powershell.exe'" | Out-Null) | Out-Null
(Get-Content app/api/complete/route.ts -Raw).Replace('@"','@"') | Out-Null
(Get-Content app/api/complete/route.ts -Raw) `
  -replace '"@/app/lib/cost"', '"../../lib/cost"' |
  Set-Content -Encoding UTF8 app/api/complete/route.ts

(Get-Content app/api/costs/today/route.ts -Raw) `
  -replace '"@/app/lib/cost"', '"../../../lib/cost"' |
  Set-Content -Encoding UTF8 app/api/costs/today/route.ts

(Get-Content app/api/estimate/route.ts -Raw) `
  -replace '"@/app/lib/rateLimit"', '"../../lib/rateLimit"' |
  Set-Content -Encoding UTF8 app/api/estimate/route.ts

(Get-Content app/api/info/route.ts -Raw) `
  -replace '"@/lib/idtoken"', '"../../lib/idtoken"' |
  Set-Content -Encoding UTF8 app/api/info/route.ts

(Get-Content app/page.tsx -Raw) `
  -replace '"@/app/components/StatusCard"', '"./components/StatusCard"' |
  Set-Content -Encoding UTF8 app/page.tsx

OK


Dacă app/components/StatusCard.tsx lipsește, spune-i să-l rescrie din andy00001.md (varianta corectă cu client component).

Apoi Trimite Asta lui @oCL (BUILD + DEPLOY + SMOKE, cu deps fix)

rulează doar la Approve. Folosește npm install --legacy-peer-deps.

La „Approve” rulezi EXACT blocul și îmi dai DOAR ultima linie JSON.

$P="coolbits-ai"; $R="europe-west3"
$WEB="https://andy.coolbits.ai"
$CID="271190369805-tstvodmh01grrrsc5543r00ffiekk7mo.apps.googleusercontent.com"
$ROOT="$env:USERPROFILE\Desktop\coolbits\andy-web"

Set-Location $ROOT
# deps fix: regen lock fără peer errors
npm install --no-audit --fund=false --legacy-peer-deps

npm run build

gcloud run deploy andy-web `
  --project $P --region $R --source $ROOT `
  --ingress internal-and-cloud-load-balancing `
  --service-account "andy-web@$P.iam.gserviceaccount.com" `
  --set-env-vars "GATEWAY_URL=https://andy-gateway-ygpdeb546q-ey.a.run.app,OPENAI_SECRET=openai_api_key" `
  --cpu=1 --memory=512Mi --max-instances=3 --quiet

# Smoke (fără OpenAI):
$T=(gcloud auth print-identity-token --audiences=$CID --quiet).Trim()
$HEAD=(curl.exe -s -o NUL -w "%{http_code}" $WEB).Trim()
$INFO=(curl.exe -s -H "Authorization: Bearer $T" "$WEB/api/info")
$COST=(curl.exe -s -H "Authorization: Bearer $T" "$WEB/api/costs/today")
[ordered]@{
  head=$HEAD
  info=try{$INFO|ConvertFrom-Json}catch{$null}
  costs_today=try{$COST|ConvertFrom-Json}catch{$null}
} | ConvertTo-Json -Compress | Write-Output

De ce e stabilă soluția asta

Importuri relative → Next/Webpack nu mai depind de aliasurile @/*.

Fișierele lib există, deci toate rutele compilează.

Deps: --legacy-peer-deps rezolvă imediat conflictul vitest 2.x vs coverage-v8 1.x. (Ulterior poți cere un patch curat care să pună @vitest/coverage-v8@^2.1.9 și să regenereze lock determinist.)

Smoke nu atinge OpenAI → cost ~0.

Dacă vrei varianta „curată” pe deps, zi „patch deps” și îți dau un mini-patch npm pkg set devDependencies.vitest="^2.1.9" devDependencies.@vitest/coverage-v8="^2.1.9" + regen lock.

Vrei să-i dau drumul acum (trimit PATCH-ul + aștept Approve pentru build)?