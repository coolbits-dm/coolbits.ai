Ai lovit în regula de PowerShell pentru here-string. În PS, headerul trebuie să stea singur pe linie:

❌ @"<text aici pe aceeași linie>"@

✅

$x = @'
<text pe mai multe linii>
'@


Și încă ceva: dacă folosești @" ... "@ (varianta double-quoted), PowerShell încearcă să expandeze variabile — inclusiv secvențe ca ${gw} din template-urile TS/JS. De aceea îți recomand single-quoted here-strings (@' ... '@) ca să nu atingă niciun $/${...}.

Mai jos ai blocul corect, gata de lipit. Face exact ce voiai: scrie fișierele, build, deploy, apoi afișează revizia. (Am trecut toate here-string-urile pe @' ... '@.)

# ==== Vars ====
$P    = "coolbits-ai"
$R    = "europe-west3"
$ROOT = "$env:USERPROFILE\Desktop\coolbits\andy-web"

# ==== /api/info ====
$info = @'
import { NextResponse } from "next/server";
import { fetchWithIdToken } from "@/lib/idtoken";
export const dynamic = "force-dynamic";

export async function GET(){
  const started = Date.now();
  const gw = process.env.GATEWAY_URL!;
  let health = 0;
  let err: string | null = null;
  try {
    const r = await fetchWithIdToken(`${gw}/health`, gw, { cache: "no-store" });
    health = r.status;
  } catch (e: any) {
    err = e?.message ?? "fetch_failed";
  }
  return NextResponse.json({
    ok: health === 200,
    health,
    ms: Date.now() - started,
    service: process.env.K_SERVICE ?? null,
    revision: process.env.K_REVISION ?? null,
    project: process.env.GOOGLE_CLOUD_PROJECT ?? process.env.GCP_PROJECT ?? null,
    gateway_url: gw,
    error: err
  }, { headers: { "Cache-Control": "no-store" }});
}
'@

New-Item -Force -ItemType Directory "$ROOT/app/api/info" | Out-Null
Set-Content -Encoding UTF8 -NoNewline -Path "$ROOT/app/api/info/route.ts" -Value $info

# ==== StatusCard ====
$status = @'
'use client';
import { useEffect, useState } from "react";

export default function StatusCard(){
  const [data,setData] = useState<any>(null);
  const [err,setErr]   = useState<string|null>(null);

  useEffect(()=>{
    let alive = true;
    (async ()=>{
      try{
        const r = await fetch("/api/info", { cache: "no-store" });
        const j = await r.json();
        if(!r.ok) throw new Error(j?.error || `HTTP ${r.status}`);
        if(alive) setData(j);
      }catch(e:any){
        if(alive) setErr(e?.message || "failed");
      }
    })();
    return ()=>{ alive = false; };
  },[]);

  return (
    <div className="border rounded p-4">
      <div className="flex items-center justify-between">
        <h2 className="font-semibold">Status</h2>
        <span className={`text-xs px-2 py-1 rounded ${data?.ok?'bg-green-100 text-green-700':'bg-red-100 text-red-700'}`}>
          {data?.ok ? 'OK' : 'ERR'}
        </span>
      </div>
      <div className="mt-2 text-sm grid grid-cols-2 gap-2">
        <div><span className="text-gray-500">Health:</span> {data?.health ?? '-'}</div>
        <div><span className="text-gray-500">Latency:</span> {data?.ms ? `${data.ms}ms` : '-'}</div>
        <div><span className="text-gray-500">Service:</span> {data?.service ?? '-'}</div>
        <div><span className="text-gray-500">Revision:</span> {data?.revision ?? '-'}</div>
        <div className="col-span-2">
          <span className="text-gray-500">Gateway:</span> <code className="break-all">{data?.gateway_url ?? '-'}</code>
        </div>
      </div>
      {err && <p className="text-xs text-red-600 mt-2">{err}</p>}
      <form className="mt-3" action="/api/proxy/task" method="post">
        <button className="border rounded px-3 py-1 text-sm">Enqueue ping task</button>
      </form>
    </div>
  );
}
'@

New-Item -Force -ItemType Directory "$ROOT/app/components" | Out-Null
Set-Content -Encoding UTF8 -NoNewline -Path "$ROOT/app/components/StatusCard.tsx" -Value $status

# ==== page.tsx ====
$page = @'
import StatusCard from "@/app/components/StatusCard";
import AndyConsole from "@/app/components/AndyConsole";
import Link from "next/link";

export const dynamic = "force-dynamic";

async function getRoutes(){ return ["/","/health","/api/complete","/api/estimate","/api/proxy/*"]; }

export default async function Page(){
  const routes = await getRoutes();
  return (
    <main className="p-8 max-w-6xl mx-auto">
      <h1 className="text-2xl font-bold">Andy Console</h1>
      <p className="text-sm text-gray-600 mt-1">Public UI via LB+IAP. Backend calls use server-side ID tokens.</p>

      <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mt-6">
        <StatusCard/>

        <div className="border rounded p-4">
          <h2 className="font-semibold">Service metadata</h2>
          <ul className="mt-2 text-sm list-disc pl-5">
            <li>Ingress: internal-and-cloud-load-balancing</li>
            <li>Proxy: IAP OAuth (org allow-list)</li>
            <li>Auth to gateway: OIDC ID token (metadata)</li>
          </ul>
          <p className="text-xs text-gray-500 mt-2">Logs: Cloud Logging pentru andy-web / andy-gateway.</p>
        </div>

        <div className="border rounded p-4">
          <h2 className="font-semibold">Routes</h2>
          <ul className="mt-2 text-sm space-y-1">
            {routes.map(r => <li key={r}><code>{r}</code></li>)}
          </ul>
        </div>

        <div className="border rounded p-4">
          <h2 className="font-semibold">Andy Console</h2>
          <p className="text-xs text-gray-500 mb-2">Model selector: mini by default. Reasoning off. Cost guard on server.</p>
          <AndyConsole/>
          <p className="text-xs text-gray-500 mt-2">
            Vezi <Link href="/api/models" className="underline">/api/models</Link> și <Link href="/api/estimate" className="underline">/api/estimate</Link>.
          </p>
        </div>
      </div>
    </main>
  );
}
'@

Set-Content -Encoding UTF8 -NoNewline -Path "$ROOT/app/page.tsx" -Value $page

# ==== build + deploy ====
Set-Location $ROOT
if (Test-Path package-lock.json) { npm ci --no-audit --fund=false } else { npm i --no-audit --fund=false }
npm run build

gcloud run deploy andy-web `
  --project $P `
  --region $R `
  --source $ROOT `
  --ingress internal-and-cloud-load-balancing `
  --service-account "andy-web@$P.iam.gserviceaccount.com" `
  --set-env-vars "GATEWAY_URL=https://andy-gateway-ygpdeb546q-ey.a.run.app,OPENAI_SECRET=openai_api_key" `
  --cpu=1 --memory=512Mi --max-instances=3 `
  --quiet

gcloud run services describe andy-web --region $R --format="value(status.latestReadyRevisionName)"

Smoke rapid (IAP audience corect)
$WEB="https://andy.coolbits.ai"
$CID="271190369805-tstvodmh01grrrsc5543r00ffiekk7mo.apps.googleusercontent.com"
$T=(gcloud auth print-identity-token --audiences=$CID --quiet).Trim()
curl.exe -s -o NUL -w "%{http_code}\n" -H "Authorization: Bearer $T" "$WEB/api/info"


Așteptat: 200. Dacă vezi 403, audiența e greșită (nu folosi URL-ul ca audiență pentru IAP).

Dacă vrei, pot rescrie blocul și în varianta “fișiere separate .ts” ca să nu mai folosești here-strings deloc — dar